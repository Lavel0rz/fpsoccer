<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Multiplayer Game</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #121212;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
    }
    
    #game-container {
      width: 1600px;
      height: 1200px;
      max-width: 100vw;
      max-height: 100vh;
      display: none; /* Hide initially */
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%); /* Center using transform */
    }
    
    canvas {
      display: block;
      margin: 0 auto; /* Center the canvas element */
    }
    
    #back-to-lobby {
      position: absolute;
      top: 10px;
      left: 10px;
      background-color: #4caf50;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      z-index: 1000;
    }
    
    #back-to-lobby:hover {
      background-color: #3e8e41;
    }
    
    #start-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
      text-align: center;
    }
    
    #start-button {
      background-color: #4caf50;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1.2em;
      margin-top: 20px;
      transition: background-color 0.3s;
    }
    
    #start-button:hover {
      background-color: #3e8e41;
    }
    
    .game-info {
      margin-bottom: 20px;
      font-size: 1.2em;
    }
    
    #connection-status {
      margin-top: 20px;
      padding: 10px;
      border-radius: 4px;
      background-color: #333;
      display: none;
    }
    
    .error {
      background-color: #ff5252 !important;
      color: white;
    }
    
    .success {
      background-color: #4caf50 !important;
      color: white;
    }
    
    .loading {
      background-color: #2196F3 !important;
      color: white;
    }
  </style>
</head>
<body>
  <button id="back-to-lobby" onclick="window.location.href='lobby.html'">Back to Lobby</button>
  
  <div id="start-screen">
    <h1>Ready to Play</h1>
    <div id="game-info" class="game-info"></div>
    <button id="start-button">Join Lobby</button>
    <div id="connection-status"></div>
  </div>
  
  <div id="game-container"></div>
  
  <script>
    // Add debug logging to help troubleshoot
    console.log('Game page loaded');
    console.log('URL parameters:', window.location.search);
    
    // Check if we're on itch.io or another hosting platform
    function isOnItchIo() {
      return window.location.hostname.includes('itch.io') || 
             window.location.hostname.includes('itchio') ||
             window.location.hostname.includes('hwcdn.net');
    }
    
    // Parse URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const gameId = urlParams.get('game_id');
    const port = urlParams.get('port') || '8080';
    const displayName = urlParams.get('display_name') || localStorage.getItem('playerDisplayName') || 'Player';
    
    // Store the display name in localStorage for future use
    localStorage.setItem('playerDisplayName', displayName);
    
    console.log('Game ID:', gameId);
    console.log('Port:', port);
    console.log('Display Name:', displayName);
    
    // Make the display name available to the game
    window.PLAYER_DISPLAY_NAME = displayName;
    
    // If we're on itch.io and there's no game ID, redirect to lobby
    if (isOnItchIo() && !gameId) {
      console.log('No game ID provided on itch.io, redirecting to lobby...');
      window.location.href = 'lobby.html';
    }
    
    // Set the WebSocket URL - use game-specific path
    window.WEBSOCKET_URL = gameId 
        ? `wss://towerup.io/game/${gameId}/ws` 
        : `wss://towerup.io/ws`;
    console.log('WebSocket URL:', window.WEBSOCKET_URL);
    
    // Update game info display
    const gameInfo = document.getElementById('game-info');
    const connectionStatus = document.getElementById('connection-status');
    const startButton = document.getElementById('start-button');
    const gameContainer = document.getElementById('game-container');
    
    if (gameId) {
      gameInfo.textContent = `Game ID: ${gameId} | Port: ${port}`;
      console.log(`Joining specific game with ID: ${gameId}`);
    } else {
      gameInfo.textContent = 'Quick Play Mode';
      console.log('Quick Play Mode - using default game instance');
    }
    
    // Test connection to the game server
    function testConnection() {
      connectionStatus.style.display = 'block';
      connectionStatus.textContent = 'Testing connection to game server...';
      connectionStatus.className = 'status loading';
      
      console.log('Attempting to connect to:', window.WEBSOCKET_URL);
      
      const testSocket = new WebSocket(window.WEBSOCKET_URL);
      let connectionTimeout = setTimeout(() => {
        testSocket.close();
        connectionStatus.textContent = 'Connection timeout. The server might still be starting up. Retrying...';
        connectionStatus.className = 'status error';
        startButton.disabled = true;
        
        // Try again in 2 seconds
        setTimeout(testConnection, 2000);
      }, 5000);
      
      testSocket.addEventListener('open', () => {
        console.log('WebSocket connection opened successfully');
        clearTimeout(connectionTimeout);
        connectionStatus.textContent = 'Connected to game server!';
        connectionStatus.className = 'status success';
        startButton.disabled = false;
        
        // Send a ping to make sure the connection is working
        testSocket.send(JSON.stringify({ type: "ping", timestamp: Date.now() }));
        
        // Close the test socket after a short delay
        setTimeout(() => {
          testSocket.close();
        }, 500);
      });
      
      testSocket.addEventListener('error', (error) => {
        console.error('WebSocket error:', error);
        clearTimeout(connectionTimeout);
        connectionStatus.textContent = 'Could not connect to game server. The server might still be starting up. Please wait a moment and try again.';
        connectionStatus.className = 'status error';
        startButton.disabled = true;
        
        console.log('Connection error to', window.WEBSOCKET_URL);
        
        // Try again in 2 seconds
        setTimeout(testConnection, 2000);
      });
      
      testSocket.addEventListener('message', (event) => {
        console.log('Received message from server:', event.data);
      });
    }
    
    // Start button event listener
    startButton.addEventListener('click', function() {
      // Hide start screen and show game container
      document.getElementById('start-screen').style.display = 'none';
      gameContainer.style.display = 'block';
      
      // Ensure the game container is properly centered
      window.addEventListener('resize', function() {
        // Force recenter on resize
        gameContainer.style.top = '50%';
        gameContainer.style.left = '50%';
        gameContainer.style.transform = 'translate(-50%, -50%)';
      });
      
      // Load the game script
      const script = document.createElement('script');
      script.src = 'main.js';
      document.body.appendChild(script);
    });
    
    // Check if assets are accessible
    fetch('assets/ship.png')
      .then(response => {
        if (response.ok) {
          console.log('Assets are accessible');
          // Test connection after assets are verified
          testConnection();
        } else {
          console.error('Assets are not accessible');
          connectionStatus.style.display = 'block';
          connectionStatus.textContent = 'Could not load game assets. Please refresh the page.';
          connectionStatus.className = 'error';
          startButton.disabled = true;
        }
      })
      .catch(error => {
        console.error('Error checking assets:', error);
        connectionStatus.style.display = 'block';
        connectionStatus.textContent = 'Error loading game assets. Please refresh the page.';
        connectionStatus.className = 'error';
        startButton.disabled = true;
      });
  </script>
</body>
</html> 