<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Game Lobby</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      background-color: #121212;
      color: #ffffff;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      width: 100vw;
      box-sizing: border-box;
      overflow-x: hidden;
    }
    
    .container {
      width: 100%;
      max-width: 800px;
      background-color: #1e1e1e;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      margin: 0 auto;
    }
    
    h1 {
      text-align: center;
      color: #4caf50;
      margin-bottom: 30px;
    }
    
    .section {
      margin-bottom: 30px;
      padding: 15px;
      background-color: #2a2a2a;
      border-radius: 5px;
    }
    
    .section-title {
      font-size: 1.2em;
      margin-bottom: 15px;
      color: #4caf50;
    }
    
    button {
      background-color: #4caf50;
      color: white;
      border: none;
      padding: 10px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1em;
      margin: 5px;
      transition: background-color 0.3s;
    }
    
    button:hover {
      background-color: #3e8e41;
    }
    
    button:disabled {
      background-color: #555555;
      cursor: not-allowed;
    }
    
    input, select {
      padding: 8px;
      margin: 5px;
      border-radius: 4px;
      border: 1px solid #555;
      background-color: #333;
      color: white;
      width: calc(100% - 20px);
    }
    
    .game-list {
      list-style-type: none;
      padding: 0;
    }
    
    .game-item {
      padding: 10px;
      margin-bottom: 8px;
      background-color: #333;
      border-radius: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .game-info {
      flex-grow: 1;
    }
    
    .status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      background-color: #333;
    }
    
    .error {
      background-color: #ff5252;
      color: white;
    }
    
    .success {
      background-color: #4caf50;
      color: white;
    }
    
    .loading {
      background-color: #2196F3;
      color: white;
    }
    
    .quick-play {
      text-align: center;
      margin-top: 20px;
    }
    
    .quick-play button {
      padding: 12px 24px;
      font-size: 1.1em;
    }
    
    .checkbox-container {
      display: flex;
      align-items: center;
      margin: 10px 0;
    }
    
    .checkbox-container input[type="checkbox"] {
      width: auto;
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Game Lobby</h1>
    
    <div class="section">
      <div class="section-title">Connection Status</div>
      <div id="connection-status" class="status">Disconnected</div>
    </div>
    
    <div class="section">
      <div class="section-title">Create Game</div>
      <div>
        <input type="text" id="game-name" placeholder="Game Name" />
        <select id="max-players">
          <option value="2">2 Players</option>
          <option value="4">4 Players</option>
          <option value="6">6 Players</option>
          <option value="8">8 Players</option>
        </select>
        <div class="checkbox-container">
          <input type="checkbox" id="is-public" checked />
          <label for="is-public">Public Game (visible to other players)</label>
        </div>
        <button id="create-game-btn">Create Game</button>
      </div>
    </div>
    
    <div class="section">
      <div class="section-title">Available Games</div>
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <span id="games-count">No games available</span>
        <button id="refresh-games-btn">Refresh Games</button>
      </div>
      <ul id="game-list" class="game-list">
        <li class="game-item">
          <div class="game-info">No games available</div>
        </li>
      </ul>
    </div>
    
    <div class="quick-play">
      <button onclick="window.location.href='game.html'">Quick Play</button>
    </div>
  </div>
  
  <script>
    // Connection variables
    let socket = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    let reconnectTimer = null;
    
    // Check if we're on itch.io or another hosting platform
    function isOnItchIo() {
      return window.location.hostname.includes('itch.io') || 
             window.location.hostname.includes('itchio') ||
             window.location.hostname.includes('hwcdn.net');
    }
    
    // DOM elements
    const connectionStatus = document.getElementById('connection-status');
    const createGameBtn = document.getElementById('create-game-btn');
    const refreshGamesBtn = document.getElementById('refresh-games-btn');
    const gameList = document.getElementById('game-list');
    const gameNameInput = document.getElementById('game-name');
    const maxPlayersSelect = document.getElementById('max-players');
    const isPublicCheckbox = document.getElementById('is-public');
    const gamesCount = document.getElementById('games-count');
    
    // Connect to the lobby server
    function connectToLobby() {
      connectionStatus.textContent = 'Connecting...';
      connectionStatus.className = 'status loading';
      
      // Clear existing connection if any
      if (socket) {
        socket.close();
      }
      
      // Create a new WebSocket connection - for production, we use path-based routing
      let wsUrl = 'wss://towerup.io/lobby';
      
      // Log connection attempt
      console.log('Connecting to lobby server at:', wsUrl);
      
      socket = new WebSocket(wsUrl);
      
      // Connection opened
      socket.addEventListener('open', () => {
        connectionStatus.textContent = 'Connected to lobby server';
        connectionStatus.className = 'status success';
        reconnectAttempts = 0;
        if (reconnectTimer) {
          clearTimeout(reconnectTimer);
          reconnectTimer = null;
        }
        
        // Enable buttons
        createGameBtn.disabled = false;
        refreshGamesBtn.disabled = false;
        
        // Request the list of available games
        refreshGameList();
      });
      
      // Listen for messages
      socket.addEventListener('message', (event) => {
        try {
          const message = JSON.parse(event.data);
          handleLobbyMessage(message);
        } catch (error) {
          console.error('Error parsing message:', error);
          showNotification('Error parsing server message', true);
        }
      });
      
      // Connection closed
      socket.addEventListener('close', () => {
        connectionStatus.textContent = 'Disconnected from lobby server';
        connectionStatus.className = 'status error';
        
        // Disable buttons
        createGameBtn.disabled = true;
        refreshGamesBtn.disabled = true;
        
        // Try to reconnect
        if (reconnectAttempts < maxReconnectAttempts) {
          reconnectAttempts++;
          const delay = 2000 * reconnectAttempts;
          showNotification(`Connection lost. Reconnecting in ${delay/1000} seconds...`, true);
          reconnectTimer = setTimeout(connectToLobby, delay);
        } else {
          showNotification('Could not reconnect to server. Please refresh the page.', true);
        }
      });
      
      // Connection error
      socket.addEventListener('error', (error) => {
        console.error('WebSocket error:', error);
        connectionStatus.textContent = 'Connection error';
        connectionStatus.className = 'status error';
      });
    }
    
    // Handle messages from the lobby server
    function handleLobbyMessage(message) {
      console.log('Received message:', message);
      
      switch (message.type) {
        case 'game_list':
          updateGameList(message.games);
          break;
          
        case 'game_created':
          showNotification(`Game created! Redirecting to game...`);
          // Redirect to the game page with the game ID and port
          setTimeout(() => {
            window.location.href = `game.html?game_id=${message.game_id}&port=${message.port}`;
          }, 1000);
          break;
          
        case 'game_joined':
          showNotification(`Joined game! Redirecting...`);
          // Redirect to the game page with the game ID and port
          setTimeout(() => {
            window.location.href = `game.html?game_id=${message.game_id}&port=${message.port}`;
          }, 1000);
          break;
          
        case 'error':
          showNotification(message.message, true);
          break;
      }
    }
    
    // Update the game list
    function updateGameList(games) {
      // Clear the current list
      gameList.innerHTML = '';
      
      if (games.length === 0) {
        gameList.innerHTML = '<li class="game-item"><div class="game-info">No games available</div></li>';
        gamesCount.textContent = 'No games available';
        return;
      }
      
      gamesCount.textContent = `${games.length} game${games.length > 1 ? 's' : ''} available`;
      
      // Add each game to the list
      games.forEach(game => {
        const gameItem = document.createElement('li');
        gameItem.className = 'game-item';
        
        const gameInfo = document.createElement('div');
        gameInfo.className = 'game-info';
        gameInfo.textContent = `${game.name} (${game.player_count}/${game.max_players} players)`;
        
        const joinButton = document.createElement('button');
        joinButton.textContent = 'Join Game';
        joinButton.addEventListener('click', () => {
          joinButton.disabled = true;
          joinButton.textContent = 'Joining...';
          joinGame(game.id);
        });
        
        gameItem.appendChild(gameInfo);
        gameItem.appendChild(joinButton);
        gameList.appendChild(gameItem);
      });
    }
    
    // Create a new game
    function createGame() {
      if (!socket || socket.readyState !== WebSocket.OPEN) {
        showNotification('Not connected to lobby server', true);
        return;
      }
      
      const gameName = gameNameInput.value.trim();
      if (!gameName) {
        showNotification('Please enter a game name', true);
        return;
      }
      
      const maxPlayers = parseInt(maxPlayersSelect.value);
      const isPublic = isPublicCheckbox.checked;
      
      // Disable the create button and show loading state
      createGameBtn.disabled = true;
      createGameBtn.textContent = 'Creating...';
      
      const message = {
        type: 'create_game',
        name: gameName,
        max_players: maxPlayers,
        is_public: isPublic
      };
      
      socket.send(JSON.stringify(message));
      
      // Show notification
      showNotification('Creating game...', false, 'loading');
    }
    
    // Join a game
    function joinGame(gameId) {
      if (!socket || socket.readyState !== WebSocket.OPEN) {
        showNotification('Not connected to lobby server', true);
        return;
      }
      
      const message = {
        type: 'join_game',
        game_id: gameId
      };
      
      socket.send(JSON.stringify(message));
      
      // Show notification
      showNotification('Joining game...', false, 'loading');
    }
    
    // Refresh the game list
    function refreshGameList() {
      if (!socket || socket.readyState !== WebSocket.OPEN) {
        showNotification('Not connected to lobby server', true);
        return;
      }
      
      // Update button state
      refreshGamesBtn.disabled = true;
      refreshGamesBtn.textContent = 'Refreshing...';
      
      const message = {
        type: 'list_games'
      };
      
      socket.send(JSON.stringify(message));
      
      // Reset button after a short delay
      setTimeout(() => {
        refreshGamesBtn.disabled = false;
        refreshGamesBtn.textContent = 'Refresh Games';
      }, 1000);
    }
    
    // Show a notification
    function showNotification(message, isError = false, className = null) {
      const notification = document.createElement('div');
      notification.textContent = message;
      notification.className = className ? `status ${className}` : (isError ? 'status error' : 'status success');
      
      // Insert after connection status
      connectionStatus.parentNode.insertBefore(notification, connectionStatus.nextSibling);
      
      // Remove after 5 seconds
      setTimeout(() => {
        notification.remove();
      }, 5000);
    }
    
    // Event listeners
    createGameBtn.addEventListener('click', createGame);
    refreshGamesBtn.addEventListener('click', refreshGameList);
    
    // Disable buttons initially
    createGameBtn.disabled = true;
    refreshGamesBtn.disabled = true;
    
    // Connect to the lobby server when the page loads
    window.addEventListener('load', connectToLobby);
  </script>
</body>
</html> 